# docker-compose.yml — Local multi-service development
#
# Usage:
#   cp .env.example .env   # then fill in your API keys
#   docker compose up --build
#
# Services:
#   redis         – Session store (port 6379)
#   stt-service   – Speech-to-Text  (port 8001)
#   llm-service   – Language Model   (port 8002)
#   tts-service   – Text-to-Speech   (port 8003)
#   api-gateway   – API Gateway       (port 8000)

version: "3.9"

x-backend-common: &backend-common
  build:
    context: .
    dockerfile: Dockerfile.dev
  env_file: .env
  restart: unless-stopped

services:
  # ── Redis ──────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # ── STT Service ────────────────────────────────────────────
  stt-service:
    <<: *backend-common
    command: uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload
    working_dir: /app/stt-service
    ports:
      - "8001:8001"
    volumes:
      - ./backend/stt-service:/app/stt-service
    environment:
      PORT: "8001"

  # ── LLM Service ────────────────────────────────────────────
  llm-service:
    <<: *backend-common
    command: uvicorn app.main:app --host 0.0.0.0 --port 8002 --reload
    working_dir: /app/llm-service
    ports:
      - "8002:8002"
    volumes:
      - ./backend/llm-service:/app/llm-service
    environment:
      PORT: "8002"

  # ── TTS Service ────────────────────────────────────────────
  tts-service:
    <<: *backend-common
    command: uvicorn app.main:app --host 0.0.0.0 --port 8003 --reload
    working_dir: /app/tts-service
    ports:
      - "8003:8003"
    volumes:
      - ./backend/tts-service:/app/tts-service
    environment:
      PORT: "8003"

  # ── API Gateway ────────────────────────────────────────────
  api-gateway:
    <<: *backend-common
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    working_dir: /app/api-gateway
    ports:
      - "8000:8000"
    volumes:
      - ./backend/api-gateway:/app/api-gateway
    depends_on:
      redis:
        condition: service_healthy
      stt-service:
        condition: service_started
      llm-service:
        condition: service_started
      tts-service:
        condition: service_started
    environment:
      PORT: "8000"
      REDIS_URL: redis://redis:6379/0
      STT_SERVICE_URL: http://stt-service:8001
      LLM_SERVICE_URL: http://llm-service:8002
      TTS_SERVICE_URL: http://tts-service:8003

volumes:
  redis-data:
